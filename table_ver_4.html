<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Akademik Ko√ß V5.2</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- G√úVENLƒ∞ TEMA VE AYARLAR ---
        // LocalStorage hatasƒ±nƒ± √∂nlemek i√ßin try-catch bloƒüu
        function getSafeTheme() {
            try { return localStorage.getItem('theme'); } catch (e) { return null; }
        }
        function setSafeTheme(val) {
            try { localStorage.setItem('theme', val); } catch (e) { console.log('Theme save error'); }
        }

        // Sayfa y√ºklenmeden temayƒ± uygula (Flicker √∂nleme)
        if (getSafeTheme() === 'dark' || (!getSafeTheme() && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#4f46e5",
                        secondary: "#8b5cf6",
                        "bg-light": "#f8fafc",
                        "bg-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: { sans: ["Inter", "sans-serif"] }
                },
            },
        };
    </script>

    <style>
        .grid-cols-custom {
            grid-template-columns: 220px repeat(7, minmax(160px, 1fr));
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .dark .glass-effect {
            background: rgba(30, 41, 59, 0.95);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Birle≈üik Kart ƒ∞√ßin √ñzel Stil */
        .combined-gradient {
            background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
            border-left: 3px solid #6366f1;
        }

        .dark .combined-gradient {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(6, 78, 59, 0.3) 100%);
            border-left: 3px solid #818cf8;
        }
    </style>
</head>

<body
    class="bg-bg-light dark:bg-bg-dark text-gray-800 dark:text-gray-100 min-h-screen transition-colors duration-300 font-sans">

    <nav class="sticky top-0 z-50 glass-effect border-b border-gray-200 dark:border-gray-700 shadow-sm">
        <div class="max-w-[1920px] mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-gradient-to-br from-primary to-secondary text-white rounded-lg shadow-lg">
                    <span class="material-icons-round text-2xl">school</span>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight leading-none">AKADEMƒ∞K KO√á</h1>
                    <span class="text-[10px] uppercase tracking-widest text-gray-500 dark:text-gray-400 font-bold">V5.2
                        Final</span>
                </div>
                <div class="ml-8 flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                    <button onclick="switchView('planner')" id="btn-view-planner"
                        class="px-4 py-1.5 rounded-md text-sm font-semibold transition-all bg-white dark:bg-gray-700 shadow text-primary">Haftalƒ±k
                        Program</button>
                    <button onclick="switchView('curriculum')" id="btn-view-curriculum"
                        class="px-4 py-1.5 rounded-md text-sm font-semibold transition-all text-gray-500 hover:text-gray-700 dark:text-gray-400">Ders
                        & Konu Y√∂netimi</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="saveData()"
                    class="flex items-center gap-2 px-3 py-2 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors">
                    <span class="material-icons-round text-lg">save</span> <span class="hidden sm:inline">Kaydet</span>
                </button>
                <button onclick="toggleTheme()"
                    class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition border border-transparent dark:border-gray-700">
                    <span class="material-icons-round dark:hidden">dark_mode</span>
                    <span class="material-icons-round hidden dark:block text-yellow-400">light_mode</span>
                </button>
            </div>
        </div>
    </nav>

    <main id="view-planner" class="p-6 max-w-[1920px] mx-auto fade-in">
        <div class="flex justify-between items-center mb-6">
            <div
                class="flex items-center bg-white dark:bg-surface-dark rounded-xl p-1 shadow-sm border border-gray-200 dark:border-gray-700">
                <button onclick="changeWeek(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span
                        class="material-icons-round">chevron_left</span></button>
                <div class="px-6 text-center">
                    <span class="block text-xs text-gray-400 font-bold uppercase">G√∂r√ºnt√ºlenen Hafta</span>
                    <span id="dateDisplay" class="text-sm font-bold text-gray-800 dark:text-white">...</span>
                </div>
                <button onclick="changeWeek(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><span
                        class="material-icons-round">chevron_right</span></button>
            </div>
            <button onclick="exportToPDF()"
                class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium hover:bg-gray-900 shadow-lg shadow-gray-500/30">
                <span class="material-icons-round text-sm">picture_as_pdf</span> PDF ƒ∞ndir
            </button>
        </div>

        <div class="overflow-x-auto pb-12">
            <div id="planner-container"
                class="min-w-[1200px] bg-white dark:bg-surface-dark rounded-2xl shadow border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div
                    class="grid grid-cols-custom bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700">
                    <div
                        class="p-4 flex items-center justify-center font-bold text-gray-400 text-xs uppercase tracking-wider">
                        Dersler</div>
                    <div id="daysHeader" class="contents"></div>
                </div>
                <div id="scheduleBody" class="divide-y divide-gray-100 dark:divide-gray-700"></div>
            </div>
        </div>

        <div class="fixed bottom-8 right-8 z-40">
            <button onclick="addScheduleRow()"
                class="flex items-center gap-2 px-6 py-4 bg-primary text-white rounded-full shadow-xl shadow-indigo-500/40 hover:scale-105 transition-transform font-bold">
                <span class="material-icons-round">add</span> Yeni Satƒ±r Ekle
            </button>
        </div>
    </main>

    <main id="view-curriculum" class="hidden p-6 max-w-5xl mx-auto fade-in">
        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Ders ve Konu Y√∂netimi</h2>
            <p class="text-gray-500 dark:text-gray-400">Burada eklediƒüin dersler ve konular, haftalƒ±k programƒ±nda
                se√ßilebilir olacaktƒ±r.</p>
        </div>
        <div
            class="bg-white dark:bg-surface-dark p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8 flex gap-4 items-end">
            <div class="flex-grow">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Yeni Ders Adƒ±</label>
                <input type="text" id="newSubjectInput"
                    class="w-full rounded-lg bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-600 focus:ring-primary"
                    placeholder="√ñrn: Fizik, AYT Matematik...">
            </div>
            <button onclick="addNewSubject()"
                class="px-6 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-indigo-600 transition-colors shadow-lg shadow-indigo-500/30">EKLE</button>
        </div>
        <div id="subjectsList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </main>

    <div id="taskModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeTaskModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-surface-dark rounded-2xl shadow-2xl p-6 transition-all transform scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold flex items-center gap-2"><span
                        class="material-icons-round text-primary">edit_calendar</span> Plan Ekle</h3>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-red-500"><span
                        class="material-icons-round">close</span></button>
            </div>
            <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                <button onclick="switchModalTab('topic')" id="tab-topic"
                    class="flex-1 pb-2 text-sm font-bold text-primary border-b-2 border-primary">Konu √áalƒ±≈ümasƒ±</button>
                <button onclick="switchModalTab('generic')" id="tab-generic"
                    class="flex-1 pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700">Genel
                    G√∂rev</button>
            </div>
            <div id="modal-content-topic" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Konu Se√ß</label>
                    <select id="modalTopicSelect"
                        class="w-full rounded-lg bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-600 text-sm">
                        <option value="">L√ºtfen listeden bir konu se√ßin...</option>
                    </select>
                    <p id="noTopicWarning" class="hidden text-xs text-red-500 mt-1">* Bu ders i√ßin eklenmi≈ü konu yok.
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">Aktivite Tipi</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="studyType" value="review" class="peer sr-only" checked
                                onchange="toggleStudyInputs()">
                            <div
                                class="p-2 rounded-lg border border-gray-200 dark:border-gray-600 text-center text-sm font-medium peer-checked:bg-indigo-50 peer-checked:border-primary peer-checked:text-primary transition-all">
                                <span class="block text-xs opacity-70">üìñ</span> Konu Tekrarƒ±
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="studyType" value="test" class="peer sr-only"
                                onchange="toggleStudyInputs()">
                            <div
                                class="p-2 rounded-lg border border-gray-200 dark:border-gray-600 text-center text-sm font-medium peer-checked:bg-emerald-50 peer-checked:border-emerald-500 peer-checked:text-emerald-600 transition-all">
                                <span class="block text-xs opacity-70">üìù</span> Soru √á√∂z√ºm√º
                            </div>
                        </label>
                    </div>
                </div>
                <div id="input-review" class="fade-in">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Hedef S√ºre (Dakika)</label>
                    <input type="number" id="targetDuration"
                        class="w-full rounded-lg border-gray-200 dark:border-gray-600 dark:bg-gray-800 text-sm"
                        placeholder="√ñrn: 45">
                </div>
                <div id="input-test" class="hidden fade-in">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Hedef Soru Sayƒ±sƒ±</label>
                    <input type="number" id="targetQuestions"
                        class="w-full rounded-lg border-gray-200 dark:border-gray-600 dark:bg-gray-800 text-sm"
                        placeholder="√ñrn: 50">
                </div>
            </div>
            <div id="modal-content-generic" class="hidden space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Ba≈ülƒ±k</label>
                    <input type="text" id="genericTaskInput"
                        class="w-full rounded-lg border-gray-200 dark:border-gray-600 dark:bg-gray-800 text-sm"
                        placeholder="√ñrn: Deneme Sƒ±navƒ±">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">T√ºr</label>
                    <select id="genericTaskType"
                        class="w-full rounded-lg border-gray-200 dark:border-gray-600 dark:bg-gray-800 text-sm">
                        <option value="homework">√ñdev</option>
                        <option value="exam">Sƒ±nav</option>
                        <option value="project">Proje</option>
                    </select>
                </div>
            </div>
            <button onclick="confirmAddTask()"
                class="w-full mt-6 py-3 bg-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">PLANA
                EKLE</button>
        </div>
    </div>

    <script>
        // --- 1. VERƒ∞ VE BA≈ûLANGI√á AYARLARI ---
        const defaultSubjects = [
            { id: 'mat', name: 'Matematik', topics: ['Temel Kavramlar', 'Sayƒ± Basamaklarƒ±', '√úsl√º Sayƒ±lar'] },
            { id: 'fiz', name: 'Fizik', topics: ['Vekt√∂rler', 'Kuvvet ve Hareket'] },
            { id: 'kim', name: 'Kimya', topics: ['Atom Modelleri', 'Periyodik Sistem'] }
        ];

        // LocalStorage'dan g√ºvenli okuma
        let curriculum = [];
        try {
            curriculum = JSON.parse(localStorage.getItem('curriculum')) || defaultSubjects;
        } catch (e) { curriculum = defaultSubjects; }

        let weekOffset = 0;
        let activeModalContext = null;
        const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma", "Cumartesi", "Pazar"];

        window.onload = () => {
            renderCurriculum();
            renderPlanner();
        };

        // --- 2. TEMA DEƒûƒ∞≈ûTƒ∞RME FONKSƒ∞YONU ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                setSafeTheme('light');
            } else {
                html.classList.add('dark');
                setSafeTheme('dark');
            }
        }

        // --- 3. G√ñR√úN√úM GE√áƒ∞≈ûLERƒ∞ ---
        function switchView(viewName) {
            const planner = document.getElementById('view-planner');
            const curr = document.getElementById('view-curriculum');
            const btnP = document.getElementById('btn-view-planner');
            const btnC = document.getElementById('btn-view-curriculum');
            if (viewName === 'planner') {
                planner.classList.remove('hidden'); curr.classList.add('hidden');
                btnP.classList.add('bg-white', 'dark:bg-gray-700', 'shadow', 'text-primary'); btnP.classList.remove('text-gray-500');
                btnC.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow', 'text-primary'); btnC.classList.add('text-gray-500');
                renderPlanner();
            } else {
                planner.classList.add('hidden'); curr.classList.remove('hidden');
                btnC.classList.add('bg-white', 'dark:bg-gray-700', 'shadow', 'text-primary'); btnC.classList.remove('text-gray-500');
                btnP.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow', 'text-primary'); btnP.classList.add('text-gray-500');
            }
        }

        // --- 4. M√úFREDAT Y√ñNETƒ∞Mƒ∞ ---
        function renderCurriculum() {
            const list = document.getElementById('subjectsList');
            list.innerHTML = '';
            curriculum.forEach((sub, index) => {
                const topicsHtml = sub.topics.map((t, tIndex) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-100 dark:border-gray-700 group">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${t}</span>
                        <button onclick="deleteTopic(${index}, ${tIndex})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600"><span class="material-icons-round text-sm">close</span></button>
                    </div>`).join('');
                const card = document.createElement('div');
                card.className = "bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden transition-all hover:shadow-md";
                card.innerHTML = `
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-primary">${sub.name}</h3>
                        <button onclick="deleteSubject(${index})" class="text-gray-400 hover:text-red-500 p-1"><span class="material-icons-round">delete</span></button>
                    </div>
                    <div class="p-4">
                        <div class="space-y-2 mb-4 max-h-40 overflow-y-auto hide-scrollbar">${topicsHtml}</div>
                        <div class="flex gap-2 mt-4">
                            <input type="text" id="topic-input-${index}" class="flex-grow rounded-md text-sm bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-600 focus:ring-1 focus:ring-primary py-1.5" placeholder="Yeni konu...">
                            <button onclick="addTopic(${index})" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md text-xs font-bold hover:bg-primary hover:text-white transition-colors">EKLE</button>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
        }
        function addNewSubject() {
            const val = document.getElementById('newSubjectInput').value.trim();
            if (val) { curriculum.push({ id: Date.now().toString(), name: val, topics: [] }); document.getElementById('newSubjectInput').value = ''; saveCurriculum(); renderCurriculum(); }
        }
        function deleteSubject(i) { if (confirm("Ders silinsin mi?")) { curriculum.splice(i, 1); saveCurriculum(); renderCurriculum(); } }
        function addTopic(i) { const el = document.getElementById(`topic-input-${i}`); if (el.value.trim()) { curriculum[i].topics.push(el.value.trim()); el.value = ''; saveCurriculum(); renderCurriculum(); } }
        function deleteTopic(si, ti) { curriculum[si].topics.splice(ti, 1); saveCurriculum(); renderCurriculum(); }
        function saveCurriculum() { try { localStorage.setItem('curriculum', JSON.stringify(curriculum)); } catch (e) { } }

        // --- 5. PLANLAYICI (RENDER ve Bƒ∞RLE≈ûTƒ∞RME MANTIƒûI) ---
        function getWeekKey() {
            const d = new Date(); const diff = d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1) + (weekOffset * 7);
            return new Date(d.setDate(diff)).toISOString().slice(0, 10);
        }
        function changeWeek(diff) { weekOffset += diff; renderPlanner(); }

        function renderPlanner() {
            const weekKey = getWeekKey();
            let savedData = { rows: [] };
            try { savedData = JSON.parse(localStorage.getItem(`schedule_${weekKey}`)) || { rows: [] }; } catch (e) { }

            // Tarih Ba≈ülƒ±klarƒ±
            const headerDiv = document.getElementById('daysHeader');
            const d = new Date(); const diff = d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1) + (weekOffset * 7);
            const startOfWeek = new Date(d.setDate(diff));
            document.getElementById('dateDisplay').innerText = startOfWeek.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }) + " Haftasƒ±";

            let headerHtml = '';
            for (let i = 0; i < 7; i++) {
                let tempD = new Date(startOfWeek); tempD.setDate(startOfWeek.getDate() + i);
                const isToday = new Date().toDateString() === tempD.toDateString();
                headerHtml += `<div class="p-3 text-center border-l border-gray-100 dark:border-gray-700 ${isToday ? 'bg-blue-50/50 dark:bg-blue-900/20' : ''}">
                        <div class="text-sm font-bold ${isToday ? 'text-primary' : 'text-gray-700 dark:text-gray-300'}">${days[i]}</div>
                        <div class="text-[10px] text-gray-400 mt-1">${tempD.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })}</div>
                    </div>`;
            }
            headerDiv.innerHTML = headerHtml;

            // Tabloyu Olu≈ütur
            const body = document.getElementById('scheduleBody'); body.innerHTML = '';
            const rowsToRender = savedData.rows.length > 0 ? savedData.rows : [null, null, null];
            rowsToRender.forEach((rowData, index) => body.appendChild(createScheduleRow(index, rowData)));
            updateAllSubjectSelects();
        }

        function createScheduleRow(rowIndex, data = null) {
            const div = document.createElement('div');
            div.className = "grid grid-cols-custom bg-white dark:bg-surface-dark group hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
            div.innerHTML = `<div class="p-3 border-r border-gray-200 dark:border-gray-700 flex flex-col justify-center gap-2 relative">
                    <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-400">DERS ${rowIndex + 1}</span>
                    <button onclick="removeRow(this)" class="text-gray-300 hover:text-red-500"><span class="material-icons-round text-sm">delete</span></button></div>
                    <select class="row-subject-select w-full text-sm font-semibold rounded-lg border-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:ring-primary focus:border-primary" onchange="saveData()"><option value="">Se√ßiniz...</option></select>
                </div>`;

            // Bƒ∞RLE≈ûTƒ∞RME ALGORƒ∞TMASI
            for (let i = 0; i < 7; i++) {
                const rawTasks = data && data.tasks[i] ? data.tasks[i] : [];
                let displayTasks = [];
                let topicMap = {};

                // 1. Grupla
                rawTasks.forEach(task => {
                    if (task.category === 'topic') {
                        if (!topicMap[task.topic]) topicMap[task.topic] = {};
                        topicMap[task.topic][task.studyType] = task;
                    } else {
                        displayTasks.push({ mode: 'single', data: task });
                    }
                });

                // 2. Birle≈ütir
                Object.keys(topicMap).forEach(topic => {
                    const group = topicMap[topic];
                    if (group.review && group.test) {
                        displayTasks.push({ mode: 'combined', review: group.review, test: group.test });
                    } else if (group.review) {
                        displayTasks.push({ mode: 'single', data: group.review });
                    } else if (group.test) {
                        displayTasks.push({ mode: 'single', data: group.test });
                    }
                });

                // 3. HTML
                let cellContent = `<div class="tasks-container flex flex-col gap-2 min-h-[100px] p-2">`;
                displayTasks.forEach(item => {
                    if (item.mode === 'combined') {
                        cellContent += createCombinedCardHTML(item.review, item.test);
                    } else {
                        cellContent += createTaskCardHTML(item.data);
                    }
                });

                cellContent += `</div><button onclick="openTaskModal(this, ${i})" class="absolute bottom-1 right-1 w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-400 hover:text-primary hover:bg-white hover:shadow flex items-center justify-center transition-all opacity-0 group-hover:opacity-100"><span class="material-icons-round text-sm">add</span></button>`;

                const cell = document.createElement('div');
                cell.className = "relative border-l border-gray-100 dark:border-gray-700 p-1 group/cell hover:bg-white dark:hover:bg-gray-700/50 transition-colors";
                cell.innerHTML = cellContent;
                div.appendChild(cell);
            }
            setTimeout(() => { if (data && data.subject) div.querySelector('.row-subject-select').value = data.subject; }, 0);
            return div;
        }

        // --- HTML KART OLU≈ûTURUCULAR ---
        function createCombinedCardHTML(reviewTask, testTask) {
            return `
            <div class="combined-card combined-gradient relative group/card cursor-pointer p-2 rounded-lg border border-indigo-100 dark:border-indigo-900 shadow-sm hover:shadow-md transition-all" onclick="deleteCombinedTask(this)">
                <div class="font-bold text-xs text-indigo-900 dark:text-indigo-100 mb-1.5 truncate">${reviewTask.topic}</div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1 bg-white/60 dark:bg-black/20 px-1.5 py-0.5 rounded text-[10px] text-indigo-700 dark:text-indigo-300 font-medium">
                        <span class="material-icons-round text-[10px]">menu_book</span> ${reviewTask.target} dk
                    </div>
                    <div class="flex items-center gap-1 bg-white/60 dark:bg-black/20 px-1.5 py-0.5 rounded text-[10px] text-emerald-700 dark:text-emerald-300 font-medium">
                        <span class="material-icons-round text-[10px]">quiz</span> ${testTask.target} Soru
                    </div>
                </div>
                <div class="hidden data-review" data-topic="${reviewTask.topic}" data-target="${reviewTask.target}"></div>
                <div class="hidden data-test" data-topic="${testTask.topic}" data-target="${testTask.target}"></div>
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover/card:opacity-100 shadow text-[10px]">x</div>
            </div>`;
        }

        function createTaskCardHTML(task) {
            if (task.category === 'topic') {
                const isReview = task.studyType === 'review';
                const colorClass = isReview ? 'bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800'
                    : 'bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800';
                const icon = isReview ? 'menu_book' : 'quiz';
                const meta = isReview ? `${task.target} dk` : `${task.target} Soru`;
                return `<div class="single-card relative group/card cursor-pointer p-2 rounded-lg border ${colorClass} text-xs shadow-sm hover:shadow-md transition-all" onclick="deleteTask(this)">
                    <div class="flex justify-between items-start mb-1"><span class="font-bold truncate w-10/12">${task.topic}</span><span class="material-icons-round text-[10px] opacity-50">${icon}</span></div>
                    <div class="flex items-center gap-1 opacity-80"><span class="font-mono font-bold bg-white dark:bg-black/20 px-1 rounded">${meta}</span></div>
                    <div class="hidden data-meta" data-cat="topic" data-topic="${task.topic}" data-type="${task.studyType}" data-target="${task.target}"></div>
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover/card:opacity-100 shadow text-[10px]">x</div>
                </div>`;
            } else {
                let colorClass = 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700 dark:text-gray-300';
                if (task.type === 'exam') colorClass = 'bg-red-50 text-red-700 border-red-100 dark:bg-red-900/30 dark:text-red-300';
                if (task.type === 'homework') colorClass = 'bg-yellow-50 text-yellow-700 border-yellow-100 dark:bg-yellow-900/30 dark:text-yellow-300';
                return `<div class="single-card relative group/card cursor-pointer p-2 rounded-lg border ${colorClass} text-xs shadow-sm hover:shadow-md transition-all" onclick="deleteTask(this)">
                    <div class="font-bold mb-0.5">${task.text}</div>
                    <div class="opacity-70 text-[10px] uppercase tracking-wide">${task.typeLabel}</div>
                    <div class="hidden data-meta" data-cat="generic" data-text="${task.text}" data-type="${task.type}" data-label="${task.typeLabel}"></div>
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover/card:opacity-100 shadow text-[10px]">x</div>
                </div>`;
            }
        }

        // --- YARDIMCI FONKSƒ∞YONLAR ---
        function updateAllSubjectSelects() {
            const selects = document.querySelectorAll('.row-subject-select');
            const options = curriculum.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            selects.forEach(sel => { const v = sel.value; sel.innerHTML = `<option value="">Se√ßiniz...</option>` + options; if (v) sel.value = v; });
        }
        function addScheduleRow() { document.getElementById('scheduleBody').appendChild(createScheduleRow(document.getElementById('scheduleBody').children.length)); updateAllSubjectSelects(); }
        function removeRow(btn) { btn.closest('.grid').remove(); saveData(); }

        function openTaskModal(btn, dayIndex) {
            const rowDiv = btn.closest('.grid'); const subjectName = rowDiv.querySelector('.row-subject-select').value;
            activeModalContext = { container: btn.previousElementSibling, subjectName: subjectName };
            const modal = document.getElementById('taskModal'); const topicSelect = document.getElementById('modalTopicSelect');
            topicSelect.innerHTML = '<option value="">Konu Se√ß...</option>';
            if (subjectName) {
                const sData = curriculum.find(s => s.name === subjectName);
                if (sData && sData.topics.length > 0) { sData.topics.forEach(t => topicSelect.innerHTML += `<option value="${t}">${t}</option>`); document.getElementById('noTopicWarning').classList.add('hidden'); topicSelect.disabled = false; }
                else { document.getElementById('noTopicWarning').classList.remove('hidden'); topicSelect.disabled = true; }
                switchModalTab('topic');
            } else { switchModalTab('generic'); }
            modal.classList.remove('hidden');
        }
        function closeTaskModal() { document.getElementById('taskModal').classList.add('hidden'); }
        function switchModalTab(tab) {
            if (tab === 'topic') { document.getElementById('modal-content-topic').classList.remove('hidden'); document.getElementById('modal-content-generic').classList.add('hidden'); document.getElementById('tab-topic').className = "flex-1 pb-2 text-sm font-bold text-primary border-b-2 border-primary"; document.getElementById('tab-generic').className = "flex-1 pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent"; }
            else { document.getElementById('modal-content-topic').classList.add('hidden'); document.getElementById('modal-content-generic').classList.remove('hidden'); document.getElementById('tab-generic').className = "flex-1 pb-2 text-sm font-bold text-primary border-b-2 border-primary"; document.getElementById('tab-topic').className = "flex-1 pb-2 text-sm font-medium text-gray-500 border-b-2 border-transparent"; }
        }
        function toggleStudyInputs() {
            if (document.querySelector('input[name="studyType"]:checked').value === 'review') { document.getElementById('input-review').classList.remove('hidden'); document.getElementById('input-test').classList.add('hidden'); }
            else { document.getElementById('input-review').classList.add('hidden'); document.getElementById('input-test').classList.remove('hidden'); }
        }
        function confirmAddTask() {
            const isTopic = !document.getElementById('modal-content-topic').classList.contains('hidden');
            let taskObj = null;
            if (isTopic) {
                const topic = document.getElementById('modalTopicSelect').value;
                const type = document.querySelector('input[name="studyType"]:checked').value;
                if (!topic) return alert("Konu se√ßin!");
                taskObj = { category: 'topic', topic: topic, studyType: type, target: type === 'review' ? (document.getElementById('targetDuration').value || '30') : (document.getElementById('targetQuestions').value || '20') };
            } else {
                const text = document.getElementById('genericTaskInput').value; if (!text) return alert("Ba≈ülƒ±k giriniz");
                const type = document.getElementById('genericTaskType').value;
                let lbl = "√ñDEV"; if (type === 'exam') lbl = "SINAV"; if (type === 'project') lbl = "PROJE";
                taskObj = { category: 'generic', text: text, type: type, typeLabel: lbl };
            }
            activeModalContext.container.innerHTML += createTaskCardHTML(taskObj);
            closeTaskModal();
            saveData(true);
            document.getElementById('genericTaskInput').value = ''; document.getElementById('targetDuration').value = ''; document.getElementById('targetQuestions').value = '';
        }
        function deleteTask(el) { if (confirm("Silmek istiyor musun?")) { el.remove(); saveData(); } }
        function deleteCombinedTask(el) { if (confirm("Bu birle≈üik g√∂revi silmek istiyor musun?")) { el.remove(); saveData(); } }

        // --- KAYIT (SAVE) ve PARSE ---
        function saveData(shouldRerender = false) {
            try {
                const rows = [];
                const rowDivs = document.getElementById('scheduleBody').children;
                for (let rowDiv of rowDivs) {
                    const subject = rowDiv.querySelector('.row-subject-select').value;
                    const tasks = [];
                    const dayContainers = rowDiv.querySelectorAll('.tasks-container');
                    dayContainers.forEach(container => {
                        const dayTaskList = [];
                        for (let card of container.children) {
                            if (card.classList.contains('combined-card')) {
                                const rData = card.querySelector('.data-review').dataset;
                                const tData = card.querySelector('.data-test').dataset;
                                dayTaskList.push({ category: 'topic', topic: rData.topic, studyType: 'review', target: rData.target });
                                dayTaskList.push({ category: 'topic', topic: tData.topic, studyType: 'test', target: tData.target });
                            } else if (card.classList.contains('single-card')) {
                                const meta = card.querySelector('.data-meta').dataset;
                                if (meta.cat === 'topic') {
                                    dayTaskList.push({ category: 'topic', topic: meta.topic, studyType: meta.type, target: meta.target });
                                } else {
                                    dayTaskList.push({ category: 'generic', text: meta.text, type: meta.type, typeLabel: meta.label });
                                }
                            }
                        }
                        tasks.push(dayTaskList);
                    });
                    rows.push({ subject, tasks });
                }
                const weekKey = getWeekKey();
                localStorage.setItem(`schedule_${weekKey}`, JSON.stringify({ rows }));

                const btn = document.querySelector('button[onclick="saveData()"]');
                if (btn) { btn.classList.add('scale-110'); setTimeout(() => btn.classList.remove('scale-110'), 200); }

                if (shouldRerender) renderPlanner();
            } catch (e) { console.log('Save error'); }
        }

        async function exportToPDF() {
            try {
                const element = document.getElementById('planner-container');
                const canvas = await html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                const width = pdf.internal.pageSize.getWidth();
                const height = (canvas.height * width) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 10, width, height);
                pdf.save('haftalik-program.pdf');
            } catch (e) { alert("PDF olu≈üturma hatasƒ±. Tarayƒ±cƒ± desteƒüini kontrol edin."); }
        }
    </script>
</body>

</html>
